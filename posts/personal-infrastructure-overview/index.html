<!doctype html><html data-color-scheme=auto><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Personal infrastructure overview · Sid Verma</title><link rel=stylesheet href=/css/rocinante.min.css><link rel=stylesheet type=text/css href=https://sidverma.io/css/style.43d9f1db361927f335592361b86ccbd6cfa942114cc7afe99c1a78eb7a648cb0.css><link rel="shortcut icon" href=/icons/favicon.ico><body><header><h2><a class=site-title href=https://sidverma.io/>‹ Sid Verma</a></h2></header><main><div class=post><div class=title-group><div class=title><h1>Personal infrastructure overview</h1></div><div class=date><h5>Jan 11, 2020</h5></div></div><article class=content><p>Writing intros to posts is such a hard thing. I&rsquo;ve spent more time on what to write in this paragraph than the rest of this article. You&rsquo;re supposed to start with a background and a motivation, and conclude with a sentence that you finally did it, and here is how.</p><p>I have not <em>done it</em> yet. This thing keeps evolving. As to why I started doing this: it&rsquo;s fun. It&rsquo;s fun and powerful to be in control of where your information resides. It&rsquo;s fun to build a system to manage this efficiently. There are also some benefits too: much more control over my data and the services. These are also all open-source so I can add missing features which I really really want, and I don&rsquo;t have to abide by the restrictive terms and limits of other platforms. And I don&rsquo;t lose everything if a platform wants to shut itself down or delete my account for using their product wrong.</p><p>As for the disadvantages: Only a few services look as polished as their commercial counterparts. It costs money to host them yourself. Mobile apps are rare. You have to think about security yourself. And if things go wrong, you only have yourself to blame.</p><hr><p>Most of my services reside across two servers, which are named <strong>HAL-9000</strong> and <strong>SAL-9000</strong>.</p><p><em>HAL</em> is a Raspberry Pi 4 connected to a single HDD, and acts as a tiny media server for personal use. It runs:</p><ul><li>A samba server (allows the HDD to be available as a Windows share)</li><li>A DLNA server (most good media players can use this to get a media index off a server)</li><li>A Calibre web server (for serving eBooks indexed by Calibre)</li><li>Jellyfin (open source alternative to Plex, to organize media)</li><li>A suite of services for downloading media (Radarr, Sonarr, Jackett, Transmission)</li><li>Syncthing (a P2P file synchronization service)</li><li>Tinc VPN (to make this server reachable over the internet)</li><li>Some monitoring services (explained later).</li></ul><figure><img src=/images/hal-9000.jpg alt="HAL resides in a makeshift housing, connected to a cool status screen"><figcaption><p>HAL resides in a makeshift housing, connected to a cool status screen</p></figcaption></figure><p><em>SAL</em> runs a lot more services, which I&rsquo;ll refrain from listing here, as I keep adding and removing them over time. The most used ones are:</p><ul><li>Mailman (for hosting a couple of private mailing lists)</li><li>Lounge + ZNC (A web IRC client for non-primary machines, and a bouncer for everywhere else)</li><li>Firefly III (Favorite expense manager)</li><li>Dokuwiki (As a personal knowledge base, also used as an idea-book and journal)</li><li>Wallabag (A self-hosted alternative to Pocket, the read-it-later thing)</li><li>FreshRSS (RSS reader with a decent frontend and Fever API support)</li><li>Radicale (A tiny cardDAV and calDAV server for syncing my contacts and calendars)</li><li>Kanboard (Kanban boards)</li><li>Tmate (an amazing tool which lets you share your current shell session with anyone else, over ssh)</li></ul><p>The complete list of services can be found in the terraform files <a href=https://github.com/mavidser/odyssey/tree/master/terraform/sal-9000 target=_blank>here</a>.</p><h2 id=internal-details>Internal details</h2><p>All of these services run in their own docker containers. This is a primary requirement for me, and I went to great lengths to make sure that nothing runs out of containers. Reasons are:</p><ul><li><em>Easier management</em>: I can store every configuration as static files, which can spin up and configure containers that are ready to go. <a href=/2019/11/15/sysadmin-terraform/>I use terraform for this</a>. Observing the state of my server becomes a breeze too.</li><li><em>Easier backups</em>: I have to backup only the mounted volumes, which greatly reduce the backup sizes, and can be backed up predictably too.</li><li><em>Easier Upgrades</em>: Upgrading services is as easy as updating the docker image tag. I don&rsquo;t have to worry of how things might break. And if they do, I can just go back to the earlier version without a hiccup.</li><li><em>Security</em>: Due to the isolated nature of containers, I feel much more safer running everything in containers, knowing that they don&rsquo;t speak to each other unless I want them to.</li><li><em>Reproducibility</em>: To set it up anew again, all I have to do is install and configure docker, make sure the OS itself is secure, and then my terraform files can take it from there. I rarely have to ever SSH into my host to make infrastructure changes.</li><li><em>Monitoring</em>: A linux system in use has tons of processes running, and to monitor your services, you have to filter through everything, identify which processes are used by which service/user, and so much more. Using containers, I can just look at the resources the container uses.</li></ul><figure><img src=/images/sal-grafana.png alt="Monitoring page of SAL-9000"><figcaption><p>Monitoring page of SAL-9000</p></figcaption></figure><h3 id=how-things-actually-connect>How things actually connect</h3><p>My home network sits behind my ISP&rsquo;s NAT, so <em>HAL</em> cannot be reached directly from the Internet. To make it accessible, I use a VPN connection (tinc) between <em>HAL</em> and <em>SAL</em> to bridge the two servers, making <em>HAL</em> locally accessible from <em>SAL</em>. In this network, <em>HAL</em> gets the IP <code>10.0.0.2</code> while <em>SAL</em> is <code>10.0.0.1</code>. This allows me to directly tunnel traffic from <em>SAL</em> to <em>HAL</em>, making it available over the internet.</p><p>Tunneling all traffic, though, would mean that services on <em>SAL</em> would be inaccessible. As it&rsquo;s not guaranteed that all traffic can be identified, I cannot do this selectively for services too. The solution was to get a Floating IP on DigitalOcean and attach it to <em>SAL</em>. Floating IPs are reassignable IP addresses, which can be attached to running instances.</p><p><em>SAL</em>, now has two public IP addresses, the floating IP and the instance&rsquo;s own public IP. The floating IP connects to <em>SAL</em> through what DigitalOcean calls an Anchor IP, which is added as an alias to the default interface. Now, I can use two different IP addresses to reach my <em>SAL</em>. One by using the <em>SAL</em>&lsquo;s public IP, and the other via the floating IP (anchor IP on the instance).</p><pre><code>                    +-------------------+
                    |      SAL-9000     |
                    | +---------------+ |
                    | |    eth0       | |
                    | |               | |
Internet ------------&gt;| 159.65.147.19 | |
  |                 | | public IP     | |
  |                 | |               | |
  V                 | |               | |
139.59.52.106 -------&gt;| 10.47.0.5     | |
Floating IP         | | anchor IP     | |
                    | +---------------+ |
                    +-------------------+
</code></pre><p>My DNS configuration says that <code>*.hal-9000</code> should point to the floating IP, while <code>*.sal-9000</code> should point to the <em>SAL</em>&lsquo;s public IP.</p><p>I use HAProxy to redirect traffic received on the anchor IP to <em>HAL</em> at <code>10.0.0.2</code> over the VPN, and keep the rest on the instance itself. This could be easily done with iptables too, but I wanted all configurations to live in Terraform, hence HAProxy. I&rsquo;ll be switching to iptables as soon as I add support for them in the <a href=https://github.com/mavidser/terraform-linux-provider target=_blank>Linux Provider</a>.</p><p>Once this step is cleared on both servers, all the traffic is forwarded to their respective docker containers. HTTP and TLS traffic, though, all goes to traefik, a reverse proxy with amazing support for Docker (with discovery), ACME, and some capable middlewares. Any contanier which needs to listen to HTTP or decrypted TCP traffic, registers itself with traefik and is ready to go. My traefik config is using Let&rsquo;s Encrypt to get signed TLS certificates.</p><h3 id=monitoring>Monitoring</h3><p>The following five services make up the monitoring stack of these servers:</p><ul><li><em>prometheus</em> as the time-series database for storing all metrics</li><li><em>node-exporter</em> to export system metrics to prometheus</li><li><em>cadvisor</em> exports metrics of docker containers to prometheus</li><li><em>loki</em> for storing logs of services</li><li><em>promtail</em> to put docker logs from the filesystem into loki</li></ul><p>Data from both the servers&rsquo; prometheus and loki is displayed on a Grafana instance running on <em>SAL</em>, which is also used for some rudimentary alerting.</p><p>A friend once asked why I was using separate loki and prometheus to store data for different servers, when one could suffice. It&rsquo;s so that <em>HAL</em> can continue to write metrics to its own databases even in case of internet disruption at my home.</p><h3 id=backups>Backups</h3><p>I use restic to backup all my docker volumes to Backblaze. Restic is able to deduplicate blobs too, so the total capacity used for backups is less than the sum of all the backups.</p><h2 id=things-i-dont-host-myself>Things I don&rsquo;t host myself</h2><p>I am using Migadu as my email provider for now, but plan to try hosting it myself on a separate server later this year.
I also use PIA as my VPN provider instead of hosting my own VPN server, mostly because I switch between regions often, and it was cheaper to use PIA than run VPN instances in different regions.</p><h2 id=how-much-does-it-cost-me>How much does it cost me?</h2><div style=font-size:.88em markdown=1><table><thead><tr><th>Service</th><th>Cost</th><th>Notes</th></tr></thead><tbody><tr><td>Domain name</td><td>$30/year</td><td>Depending on the TLD, it can be $0 to $$$</td></tr><tr><td>Cloud Server</td><td>$240/year</td><td>I have a DigitalOcean instance with 4GB memory. A 512MB one costs $60/year</td></tr><tr><td>Email</td><td>$48/year</td><td>I use migadu for my emails. It&rsquo;s a Swiss provider which allow you to have multiple custom domains as long as you don&rsquo;t send tons of emails everyday. I&rsquo;d strongly recommend that you use your own domain for emails, to keep them migratory. But, if you don&rsquo;t wanna shell out, you can go with free email providers too (Fastmail is pretty good), or maybe what <a href=https://www.dannyguo.com/blog/using-mailgun-for-a-free-custom-domain-email-address/ target=_blank>Danny recommends</a> if you really want that domain</td></tr><tr><td>Backup storage</td><td>$0/year</td><td>The 10GB free tier of Backblaze is able to store all my backups for now. It&rsquo;s still pretty cheap at 0.5c/GB when it exceeds that limit though</td></tr><tr><td>Electricity</td><td>$15/year</td><td>Raspberry Pi running at 135kWh/year at 10c/hr</td></tr><tr><td>VPN</td><td>$40/year</td><td>I use PIA as my VPN provider. Alternatively, you can setup a VPN server on your machine too, if it fits your threat model and you don&rsquo;t require all the different regions supported by PIA</td></tr><tr><td><strong>Total</strong></td><td><strong>$373/year</strong></td><td><em>If you just go with a small cloud server, and a cheap domain, you can probably bring this down to $61/year. If your home IP is not behind a NAT (static IP, or dynamic DNS), you can host this at your home too, bringing it down to just the hardware and electricity costs.</em></td></tr></tbody></table></div><p>Host things yourself. It&rsquo;s fun.</p></article><br><div class=tags><div class="horizontal-links links"><a href=/tags/homelab/>#homelab</a><a href=/tags/tech/>#tech</a></div></div></article></main><footer><div class=content-container><div class=content><p>Hey friend. I&rsquo;m <b class=sway>Sid</b>.</p><p>This is my home on the internet. Come, have a tour. Please leave your shoes at the door.</p><p>I work with technology for a living - mostly as a software engineer. Some details are available in the resume below. In addition, I&rsquo;m interested in filmmaking, tinkering with electronics, and building a decentralized internet.</p><p>I also like trees.</p><p>Email me if you&rsquo;d like to work together. <em>Or if you just wanna chat.</em><br></p><p class=horizontal-links><a href=/resume target=_blank>Resume</a><a href=/contact class=email-hook id=about-email title="Click to show email">Email</a><a href=https://github.com/mavidser target=_blank>Github</a><a href=https://instagram.com/mavidser target=_blank>Instagram</a></p><p class=horizontal-links><a href=/posts>All Posts</a><a href=/photos>Photo albums</a><a href=/tags>List of tags</a></p></div><div class=footer-text><span class=footer-emoji>✌️</span></div></div></footer><script>const emailId=atob("bWVAc2lkdmVybWEuaW8=");</script><script src=/js/rocinante.min.js></script></body></html>